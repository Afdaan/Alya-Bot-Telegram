name: Deploy AlyaBot to Self-Hosted Server (Production)

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout latest code
        uses: actions/checkout@v4

      - name: Prepare and update codebase
        run: |
          cd /opt/prod-Alya-Bot-Telegram
          git stash --include-untracked || true
          git checkout master
          git pull origin master

      - name: Restart AlyaBot via systemd
        run: |
          sudo systemctl restart prod-alya-bot.service
          echo "AlyaBot restarted via systemd (alya.service)"

      - name: Verify AlyaBot systemd service
        run: |
          sleep 5
          sudo systemctl status prod-alya-bot.service --no-pager
          if sudo systemctl is-active --quiet prod-alya-bot.service; then
            echo "‚úÖ AlyaBot is running successfully via systemd (prod-alya-bot.service)"
          else
            echo "‚ùå AlyaBot failed to start via systemd (prod-alya-bot.service)"
            exit 1
          fi

      - name: Notify deployment success via Telegram
        if: success()
        run: |
          cd /opt/prod-Alya-Bot-Telegram

          # Load credentials dari .env (no echo untuk security)
          if [ -f .env ]; then
            set -a
            source .env
            set +a
          fi

          # Validate credentials tersedia
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$ADMIN_IDS" ]; then
            exit 0
          fi

          # Get git information
          GIT_INFO=$(git log -1 --pretty=format:"%s|%h|%an|%ar")
          LAST_COMMIT_MSG=$(echo "$GIT_INFO" | cut -d'|' -f1 | sed 's/&/\&amp;/g;s/</\&lt;/g;s/>/\&gt;/g')
          LAST_COMMIT_HASH=$(echo "$GIT_INFO" | cut -d'|' -f2)
          LAST_COMMIT_AUTHOR=$(echo "$GIT_INFO" | cut -d'|' -f3 | sed 's/&/\&amp;/g;s/</\&lt;/g;s/>/\&gt;/g')
          LAST_COMMIT_TIME=$(echo "$GIT_INFO" | cut -d'|' -f4)
          BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD | sed 's/&/\&amp;/g;s/</\&lt;/g;s/>/\&gt;/g')

          # Prepare message
          TELEGRAM_API="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"
          MSG="üöÄ <b>AlyaBot Deploy Sukses (Production)!</b> üöÄ%0A%0A"
          MSG="${MSG}üì¶ <b>Branch:</b> <code>$BRANCH_NAME</code>%0A"
          MSG="${MSG}üîó <b>Commit:</b> <code>$LAST_COMMIT_HASH</code>%0A"
          MSG="${MSG}üë§ <b>Author:</b> $LAST_COMMIT_AUTHOR%0A"
          MSG="${MSG}‚è∞ <b>Time:</b> $LAST_COMMIT_TIME%0A%0A"
          MSG="${MSG}üìù <b>Changelog:</b>%0A$LAST_COMMIT_MSG%0A%0A"
          MSG="${MSG}‚ú® Bot is now running via systemd: <code>prod-alya-bot.service</code>"

          # Send ke setiap admin (hide all output)
          set +x
          IFS=',' read -ra ADMIN_ARRAY <<< "$ADMIN_IDS"
          for ADMIN_ID in "${ADMIN_ARRAY[@]}"; do
            curl -s -X POST "$TELEGRAM_API" \
              -d chat_id="$ADMIN_ID" \
              -d text="$MSG" \
              -d parse_mode="HTML" > /dev/null 2>&1
          done
          set -x

      - name: Notify deployment failure via Telegram
        if: failure()
        run: |
          cd /opt/prod-Alya-Bot-Telegram || cd /opt/prod-Alya-Bot-Telegram

          # Load credentials dari .env (no echo)
          if [ -f .env ]; then
            set -a
            source .env
            set +a
          fi

          # Validate credentials
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$ADMIN_IDS" ]; then
            exit 0
          fi

          # Get basic info
          BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
          COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")

          # Prepare failure message
          TELEGRAM_API="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"
          MSG="‚ùå <b>AlyaBot Deploy GAGAL (Production)!</b> ‚ùå%0A%0A"
          MSG="${MSG}üì¶ <b>Branch:</b> <code>$BRANCH_NAME</code>%0A"
          MSG="${MSG}üîó <b>Commit:</b> <code>$COMMIT_HASH</code>%0A%0A"
          MSG="${MSG}üîç Cek GitHub Actions logs untuk detail error."

          # Send ke setiap admin (hide all output)
          set +x
          IFS=',' read -ra ADMIN_ARRAY <<< "$ADMIN_IDS"
          for ADMIN_ID in "${ADMIN_ARRAY[@]}"; do
            curl -s -X POST "$TELEGRAM_API" \
              -d chat_id="$ADMIN_ID" \
              -d text="$MSG" \
              -d parse_mode="HTML" > /dev/null 2>&1
          done
          set -x
