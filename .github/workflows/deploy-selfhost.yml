name: Deploy AlyaBot to Self-Hosted Server

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout latest code
        uses: actions/checkout@v4

      - name: Stash local changes (if any)
        run: |
          cd /opt/Alya-Telegram
          git stash --include-untracked || true

      - name: Checkout to master branch
        run: |
          cd /opt/Alya-Telegram
          git checkout master

      - name: Pull latest code from remote
        run: |
          cd /opt/Alya-Telegram
          git pull origin master

      - name: Pull latest Docker image (if using remote registry)
        run: echo "Skip pull, using local build"

      - name: Change to project directory
        run: cd /opt/Alya-Telegram

      - name: Build Docker image (no cache)
        run: |
          cd /opt/Alya-Telegram
          export DOCKER_BUILDKIT=1
          docker build --no-cache -t alya-bot:latest .

      - name: Stop existing AlyaBot container (if running)
        run: |
          docker stop alya-bot || true
          docker rm alya-bot || true

      - name: Start AlyaBot container
        run: |
          cd /opt/Alya-Telegram
          docker run -d \
            --name alya-bot \
            --restart unless-stopped \
            --env-file .env \
            -v $PWD/data:/app/data \
            alya-bot:latest

      - name: Show running containers
        run: docker ps -a

      - name: Notify via Telegram
        if: success()
        run: |
          cd /opt/Alya-Telegram
          set -a
          source .env
          set +a

          # Get deployment info atomically
          GIT_INFO=$(git log -1 --pretty=format:"%s|%h|%an|%ar")
          LAST_COMMIT_MSG=$(echo "$GIT_INFO" | cut -d'|' -f1 | sed 's/&/\&amp;/g;s/</\&lt;/g;s/>/\&gt;/g')
          LAST_COMMIT_HASH=$(echo "$GIT_INFO" | cut -d'|' -f2)
          LAST_COMMIT_AUTHOR=$(echo "$GIT_INFO" | cut -d'|' -f3 | sed 's/&/\&amp;/g;s/</\&lt;/g;s/>/\&gt;/g')
          LAST_COMMIT_TIME=$(echo "$GIT_INFO" | cut -d'|' -f4)
          BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD | sed 's/&/\&amp;/g;s/</\&lt;/g;s/>/\&gt;/g')

          # Prepare Telegram endpoint
          TELEGRAM_API="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"

          # Encode message for HTML
          MSG="✨ AlyaBot Deploy Sukses! ✨%0A%0ABranch: <code>$BRANCH_NAME</code>%0ACommit: <code>$LAST_COMMIT_HASH</code>%0AAuthor: <b>$LAST_COMMIT_AUTHOR</b>%0ATime: $LAST_COMMIT_TIME%0A%0A<b>Changelog:</b>%0A$LAST_COMMIT_MSG"

          # Send notification with or without topic_id as needed
          if [ -n "$TELEGRAM_TOPIC_ID" ]; then
            curl -s -X POST "$TELEGRAM_API" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d message_thread_id="$TELEGRAM_TOPIC_ID" \
              -d text="$MSG" \
              -d parse_mode="HTML"
          else
            curl -s -X POST "$TELEGRAM_API" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="$MSG" \
              -d parse_mode="HTML"
          fi

          echo "✅ Deployment notification sent to Telegram"